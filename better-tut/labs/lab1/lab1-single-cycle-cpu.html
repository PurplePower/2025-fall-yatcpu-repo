
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Tokisakix">
      
      
        <link rel="canonical" href="https://purplepower.github.io/2025-fall-yatcpu-repo/better-tut/labs/lab1/lab1-single-cycle-cpu.html">
      
      
        <link rel="prev" href="../../theory/bus.html">
      
      
        <link rel="next" href="../lab2/lab2-interrupt.html">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>实验一 单周期CPU - 2025-Yatcpu-Fall-Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cpu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../index.html" title="2025-Yatcpu-Fall-Docs" class="md-header__button md-logo" aria-label="2025-Yatcpu-Fall-Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            2025-Yatcpu-Fall-Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              实验一 单周期CPU
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../index.html" title="2025-Yatcpu-Fall-Docs" class="md-nav__button md-logo" aria-label="2025-Yatcpu-Fall-Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    2025-Yatcpu-Fall-Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    前言
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../test.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    最终验收
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../intro.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    欢迎来到 YatCPU 教程仓库！
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    实验环境配置
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            实验环境配置
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/windows.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Windows 配置指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/linux-wsl.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux/WSL 配置指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/macos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    macOS 配置指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../env.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    一键配置 docker 环境
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    基础工程知识与技能
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            基础工程知识与技能
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/envvar-and-cmd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    环境变量、Shell 与 常用指令
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/scala-and-chisel.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scala 和 Chisel 编程语言
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/chisel-test.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速测试
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/simulation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    波形仿真
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/compliance-test.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    配置 RISC-V 合规性测试
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/coremark-benchmark.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    配置 CoreMark 性能基准测试
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/program-device.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    烧板验证
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/hardware-debug.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    硬件调试
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/compile-and-link.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    编译与链接
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/cmake.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cmake
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../board.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    如何一键烧板
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    理论知识基础
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            理论知识基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/cpu-arch.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    处理器架构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/riscv-isa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RISC-V 指令集架构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/interrupt-and-exception.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    中断和异常
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/bus.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    总线
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    实验
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    实验一 单周期CPU
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="lab1-single-cycle-cpu.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    实验一 单周期CPU
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cpu_1" class="md-nav__link">
    <span class="md-ellipsis">
      单周期 CPU 结构图
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      数据通路
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      控制信号
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      组合单元与状态单元
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      实现方式概述
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实现方式概述">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      取指
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      译码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      执行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      访存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      写回
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cpu_2" class="md-nav__link">
    <span class="md-ellipsis">
      组合成 CPU
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      使用自定义应用测试
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      实验报告
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/lab2-interrupt.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验二 中断
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab3/lab3-pipelined-cpu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验三 流水线 CPU
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab4/lab4-bus.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验四 总线
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../challenge1/challenge1-running-os.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    挑战实验一 运行操作系统
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    快速参考资料
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            快速参考资料
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/riscv-isa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RISC-V 指令集格式
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/ide-tips.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IDEA 和 VSCode 使用技巧
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    参考资料
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../acknowledgement.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    致谢
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cpu_1" class="md-nav__link">
    <span class="md-ellipsis">
      单周期 CPU 结构图
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      数据通路
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      控制信号
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      组合单元与状态单元
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      实现方式概述
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实现方式概述">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      取指
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      译码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      执行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      访存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      写回
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cpu_2" class="md-nav__link">
    <span class="md-ellipsis">
      组合成 CPU
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      使用自定义应用测试
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      实验报告
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="cpu">实验一 单周期CPU<a class="headerlink" href="#cpu" title="Permanent link">🚁</a></h1>
<p>单周期 CPU 一条指令的执行在一个时钟周期内完成。由于时钟周期是固定的，所以执行所有指令都必须和执行最慢指令耗费一样的时间，这导致单周期 CPU 性能很差。单周期 CPU 同一时刻只运行一条指令，指令间不会产生冲突，所以实现起来是最简单的。</p>
<p>本实验的目的是让大家理解 CPU 的基本结构以及 CPU 是如何执行指令的。我们会先向大家介绍一些基本概念，然后会按照指令执行的步骤逐步构造数据通路和控制单元（期间会留有填写代码的任务，请记得完成），最终构造成一个简单的单周期 RISC-V 处理器。</p>
<p>不管使用 IDE 还是执行命令，根目录是 <code>lab1</code> 文件夹。</p>
<h2 id="cpu_1">单周期 CPU 结构图<a class="headerlink" href="#cpu_1" title="Permanent link">🚁</a></h2>
<p>数据通路用蓝线标识，控制信号用红线标识。线路和模块的命名和代码有差异。</p>
<!-- ![](assets/single_cycle_CPU.png) -->

<p><a class="glightbox" href="assets/single_cycle_cpu.drawio.svg" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="assets/single_cycle_cpu.drawio.svg" /></a></p>
<h2 id="_1">数据通路<a class="headerlink" href="#_1" title="Permanent link">🚁</a></h2>
<p>数据在功能部件之间传送的路径称为数据通路。路径上操作或保存数据的部件称为数据通路部件，如 ALU、通用寄存器、内存等。数据通路显示了数据从一个组件流向另一个组件的所有方式。</p>
<h2 id="_2">控制信号<a class="headerlink" href="#_2" title="Permanent link">🚁</a></h2>
<p>顾名思义，控制信号控制数据通路。每当有决定要做出时，控制器单元就必须做出正确的决定并将控制信号发给相应的数据通路部件。例如：ALU 是进行加法还是减法？我们是要从内存中读取还是写入？</p>
<p>那么控制器如何弄清楚需要做什么呢？这完全取决于我们正在执行的指令。在RISC-V指令格式中，控制器通过指令的 <code>opcode</code>、<code>funct3</code>、<code>funct7</code> 字段得知该做出什么决定，从而发出正确的控制信号。 CPU 原理图中的 Decoder、ALUControl、JumpJudge 三个元件都可以看作控制单元。他们接收指令并输出控制信号。控制信号引导数据通过数据路径，以便指令正确执行。</p>
<h2 id="_3">组合单元与状态单元<a class="headerlink" href="#_3" title="Permanent link">🚁</a></h2>
<p>我们知道数字电路里有两大类型的电路，一种是组合逻辑电路，另外一种是时序逻辑电路。在 CPU 设计中，这两种电路构成的单元分别叫做组合单元和状态单元。本实验中只有寄存器属于状态单元（内存不属于 CPU 内核的范畴），其余的均为组合单元。</p>
<ul>
<li>组合单元：输出只取决于当前的输入，并且不需要时钟作为触发条件，输入会立即（不考虑延时）反映到输出</li>
<li>状态单元：存储了状态，并且以以时钟作为触发条件，时钟的上升沿到来时输入才会反映到输出</li>
</ul>
<h2 id="_4">实现方式概述<a class="headerlink" href="#_4" title="Permanent link">🚁</a></h2>
<p>我们设计的 RISC-V CPU 能执行 RISC-V 指令的一个核心子集（RV32I）：</p>
<ul>
<li>算术逻辑指令：<code>add</code>、<code>sub</code>、<code>slt</code> 等</li>
<li>存储器访问指令：<code>lb</code>、<code>lw</code>、<code>sb</code> 等</li>
<li>分支指令：<code>beq</code>、<code>jar</code> 等</li>
</ul>
<p>我们将执行指令分为五个不同的阶段：</p>
<ul>
<li>取指：从内存中获取指令数据</li>
<li>译码：弄清楚这条指令的意义，并读取寄存器数据</li>
<li>执行：用 ALU 计算结果</li>
<li>访存（<code>load</code>/<code>store</code> 指令）：读写内存</li>
<li>回写（除了 <code>store</code> 指令外所有指令）：将结果写回寄存器</li>
</ul>
<p>下面我们先按照上述步骤逐步构建数据通路部件，然后在 CPU 顶层模块将这些数据通路部件实例化并且连接起来。（下面涉及的代码都位于 <code>lab1/src/main/scala/riscv</code> 目录下）</p>
<h3 id="_5">取指<a class="headerlink" href="#_5" title="Permanent link">🚁</a></h3>
<p>代码位于 <code>core/InstructionFetch.scala</code></p>
<p>取指阶段要做的：</p>
<ul>
<li>根据当前 PC 寄存器的地址从内存中取出指令</li>
<li>修改 PC 寄存器的值使其指向下一条指令</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">ProgramCounter</span><span class="p">.</span><span class="nc">EntryAddress</span><span class="p">)</span>

<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">instruction_valid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">instruction</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">instruction_read_data</span>
<span class="w">    </span><span class="c1">// lab1(InstructionDecode)</span>
<span class="w">    </span><span class="c1">// ...</span>
</code></pre></div>
<p>首先 PC 寄存器的值被初始化为程序的入口地址。当指令有效时，先取出当前 PC 指向的指令，然后如果需要跳转则 PC 指向跳转地址，否则指向 PC+4，请你将修改 PC 寄存器的代码补充完整。</p>
<div class="admonition note">
<p class="admonition-title">实验任务</p>
<p>请在<code>core/InstructionFetch.scala</code> 的 <code>// lab1(InstructionFetch)</code> 注释处填入代码，使其能通过 <code>InstructionFetchTest</code> 单元测试。</p>
</div>
<details class="tips" open="open">
<summary>无需显式定义时钟信号</summary>
<p>Chisel 3 默认每个模块都有一个隐藏的时钟信号 <code>clock</code>，模块中的每个寄存器都默认使用这个时钟信号。</p>
</details>
<h3 id="_6">译码<a class="headerlink" href="#_6" title="Permanent link">🚁</a></h3>
<p>代码位于 <code>core/InstructionDecode.scala</code></p>
<p>译码阶段要做的：</p>
<ul>
<li>读取寄存器操作数以及立即数</li>
<li>输出控制信号</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">rs1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">instruction</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">rs2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">instruction</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>

<span class="n">io</span><span class="p">.</span><span class="n">regs_reg1_read_address</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">Instructions</span><span class="p">.</span><span class="n">lui</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="nc">Parameters</span><span class="p">.</span><span class="nc">PhysicalRegisterAddrWidth</span><span class="p">),</span><span class="w"> </span><span class="n">rs1</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">regs_reg2_read_address</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">rs2</span>
</code></pre></div>
上面的代码从指令中获取寄存器操作数的编号。除了当指令为 <code>lui</code> 时寄存器 1 为 0 号寄存器以外，其他情况寄存器 1 和寄存器 2 编号均分别为指令的 <code>rs1</code> 字段（19:15）和 <code>rs2</code> 字段（24:20）</p>
<details class="tips" open="open">
<summary>0 号寄存器</summary>
<p>为常量 0 单独分配一个寄存器使得 RISC-V ISA 更为简单，例如赋值指令可以用一个操作数为 0 的加法代替。</p>
</details>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">immediate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MuxLookup</span><span class="p">(</span>
<span class="w">  </span><span class="n">opcode</span><span class="p">,</span>
<span class="w">  </span><span class="nc">Cat</span><span class="p">(</span><span class="nc">Fill</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">instruction</span><span class="p">(</span><span class="mi">31</span><span class="p">)),</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">instruction</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">)),</span>
<span class="w">  </span><span class="nc">IndexedSeq</span><span class="p">(</span>
<span class="w">    </span><span class="nc">InstructionTypes</span><span class="p">.</span><span class="nc">I</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Cat</span><span class="p">(</span><span class="nc">Fill</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">instruction</span><span class="p">(</span><span class="mi">31</span><span class="p">)),</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">instruction</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">)),</span>
<span class="w">    </span><span class="nc">InstructionTypes</span><span class="p">.</span><span class="nc">L</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Cat</span><span class="p">(</span><span class="nc">Fill</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">instruction</span><span class="p">(</span><span class="mi">31</span><span class="p">)),</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">instruction</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">)),</span>
<span class="w">    </span><span class="c1">// ...</span>
</code></pre></div>
<p>上面的代码获取立即数。由于不同指令类型立即数的位置不同，所以要利用 <code>opcode</code> 区分指令类型，然后获取对应位置的立即数。</p>
<p><div class="highlight"><pre><span></span><code><span class="k">object</span><span class="w"> </span><span class="nc">ALUOp1Source</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">Register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">InstructionAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// ...</span>

<span class="n">io</span><span class="p">.</span><span class="n">ex_aluop1_source</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span>
<span class="w">  </span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">Instructions</span><span class="p">.</span><span class="n">auipc</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">InstructionTypes</span><span class="p">.</span><span class="nc">B</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">Instructions</span><span class="p">.</span><span class="n">jal</span><span class="p">,</span>
<span class="w">  </span><span class="nc">ALUOp1Source</span><span class="p">.</span><span class="nc">InstructionAddress</span><span class="p">,</span><span class="w">  </span>
<span class="w">  </span><span class="nc">ALUOp1Source</span><span class="p">.</span><span class="nc">Register</span>
<span class="p">)</span>
</code></pre></div>
以 <code>ex_aluop1_source</code> 控制信号为例。该控制信号控制 ALU 的第一个操作数的输入。通过 <code>opcode</code> 识别指令类型，从而为 <code>ex_aluop1_source</code> 赋值。当指令类型属于 <code>auipc</code>、<code>jal</code> 或 B 类时，<code>ex_aluop1_source</code> 置为 <code>0</code>，控制 ALU 第一个操作数的输入为指令地址；其他情况 <code>ex_aluop1_source</code> 置为 <code>1</code>，控制 ALU 第一个操作数的输入为寄存器。</p>
<p>可见译码单元的设计也是很简单的组合逻辑，知晓控制信号与指令的映射关系即可完成。下面请同学们补充为 <code>ex_aluop2_source</code>、<code>io.memory_read_enable</code>、<code>io.memory_write_enable</code>、<code>io.wb_reg_write_source</code> 四个控制信号赋值的代码。</p>
<table>
<thead>
<tr>
<th>控制信号</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ex_aluop2_source</code></td>
<td>ALU 输入来源选择</td>
</tr>
<tr>
<td><code>memory_read_enable</code></td>
<td>内存读使能</td>
</tr>
<tr>
<td><code>memory_write_enable</code></td>
<td>内存写使能</td>
</tr>
<tr>
<td><code>wb_reg_write_source</code></td>
<td>写回数据来源选择</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">实验任务</p>
<p>请在<code>core/InstructionDecode.scala</code> 的 <code>// lab1(InstructionDecode)</code> 注释处填入代码，使其能通过 <code>InstructionDecoderTest</code> 单元测试。</p>
</div>
<h3 id="_7">执行<a class="headerlink" href="#_7" title="Permanent link">🚁</a></h3>
<p>代码位于 <code>core/Execute.scala</code> </p>
<p>执行阶段要做的是：</p>
<ul>
<li>进行ALU计算</li>
<li>判断是否跳转</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">alu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">ALU</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">alu_ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">ALUControl</span><span class="p">)</span>
<span class="c1">// ...</span>
<span class="n">io</span><span class="p">.</span><span class="n">mem_alu_result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">alu</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">result</span>
</code></pre></div>
上面的代码在 <code>Execute</code> 模块内实例化了 <code>ALU</code> 和 <code>ALUcontrol</code>。具体的 ALU 计算逻辑在 <code>ALU</code> 模块进行，此处只需你在 <code>Execute</code> 模块内为 <code>ALU</code> 的输入端口赋值。<code>ALU</code> 的代码位于<code>core/ALU.scala</code>。</p>
<div class="admonition note">
<p class="admonition-title">实验任务</p>
<p>请在<code>core/Execute.scala</code> 的 <code>// lab1(Execute)</code> 注释处填入代码，使其能通过 <code>ExecuteTest</code> 单元测试。</p>
</div>
<div class="highlight"><pre><span></span><code><span class="n">io</span><span class="p">.</span><span class="n">if_jump_flag</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>
<span class="w">  </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">Instructions</span><span class="p">.</span><span class="n">jal</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">  </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">Instructions</span><span class="p">.</span><span class="n">jalr</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">  </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">InstructionTypes</span><span class="p">.</span><span class="nc">B</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">  </span><span class="nc">MuxLookup</span><span class="p">(</span>
<span class="w">    </span><span class="n">funct3</span><span class="p">,</span>
<span class="w">    </span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">,</span>
<span class="w">    </span><span class="nc">IndexedSeq</span><span class="p">(</span>
<span class="w">      </span><span class="nc">InstructionsTypeB</span><span class="p">.</span><span class="n">beq</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">reg1_data</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">reg2_data</span><span class="p">),</span>
<span class="w">      </span><span class="c1">// ...</span>
</code></pre></div>
<p>上面的代码判断是否跳转。判断是否跳转的逻辑是：如果是无条件跳转指令则直接跳转（上面代码中的 <code>jal</code>、<code>jalr</code> 指令），如果是分支指令则根据相应的跳转条件判断是否跳转（例如上面代码中的 <code>beq</code> 指令，当 <code>io.reg1_data === io.reg2_data</code> 时跳转）。跳转时将控制信号 <code>if_jump_flag</code> 置 <code>1</code>。</p>
<h3 id="_8">访存<a class="headerlink" href="#_8" title="Permanent link">🚁</a></h3>
<p>代码位于 <code>core/MemoryAccess.scala</code></p>
<p>只有 <code>load</code>/<code>store</code> 指令有访存阶段。访存阶段，读取是将内存中的数据赋给寄存器，写入反之。</p>
<p>在译码阶段，如果是 L 型指令，<code>memory_read_enable</code> 被置 <code>1</code>；如果是 S 型指令，<code>memory_write_enable</code> 被置 <code>1</code>。这两个控制信号决定了本阶段是进行读取还是写入。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">mem_address_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">alu_result</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="nc">Parameters</span><span class="p">.</span><span class="nc">WordSize</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="n">asUInt</span>
</code></pre></div>
<p>首先获取读写内存的地址。</p>
<div class="highlight"><pre><span></span><code><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">memory_read_enable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">memory_bundle</span><span class="p">.</span><span class="n">read_data</span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">wb_memory_read_data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">MuxLookup</span><span class="p">(</span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">funct3</span><span class="p">,</span>
<span class="w">    </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span>
<span class="w">    </span><span class="nc">IndexedSeq</span><span class="p">(</span>
<span class="w">      </span><span class="nc">InstructionsTypeL</span><span class="p">.</span><span class="n">lb</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">MuxLookup</span><span class="p">(</span>
<span class="w">        </span><span class="n">mem_address_index</span><span class="p">,</span>
<span class="w">        </span><span class="nc">Cat</span><span class="p">(</span><span class="nc">Fill</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="mi">31</span><span class="p">)),</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">)),</span>
<span class="w">        </span><span class="nc">IndexedSeq</span><span class="p">(</span>
<span class="w">          </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Cat</span><span class="p">(</span><span class="nc">Fill</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="mi">7</span><span class="p">)),</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)),</span>
<span class="w">          </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Cat</span><span class="p">(</span><span class="nc">Fill</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="mi">15</span><span class="p">)),</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)),</span>
<span class="w">          </span><span class="mi">2</span><span class="p">.</span><span class="nc">U</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Cat</span><span class="p">(</span><span class="nc">Fill</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="mi">23</span><span class="p">)),</span><span class="w"> </span><span class="n">data</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">))</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span><span class="p">),</span>
<span class="w">      </span><span class="nc">InstructionsTypeL</span><span class="p">.</span><span class="n">lbu</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">MuxLookup</span><span class="p">(</span>
<span class="w">      </span><span class="c1">// ...</span>
</code></pre></div>
<p>上面的代码用于读取内存。首先从总线读取数据 <code>data</code>，然后根据指令的不同对数据进行不同的处理（例如 <code>lb</code> 指令进行符号扩展，<code>lbu</code> 指令进行 0 扩展，<code>lh</code> 读取双字节等）并赋给 <code>io.wb_memory_read_data</code>，用于写回。</p>
<div class="highlight"><pre><span></span><code><span class="p">.</span><span class="n">elsewhen</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">memory_write_enable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">memory_bundle</span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">reg2_data</span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">memory_bundle</span><span class="p">.</span><span class="n">write_enable</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">.</span><span class="nc">B</span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">memory_bundle</span><span class="p">.</span><span class="n">write_strobe</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">VecInit</span><span class="p">(</span><span class="nc">Seq</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="nc">Parameters</span><span class="p">.</span><span class="nc">WordSize</span><span class="p">)(</span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">))</span>
<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">funct3</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">InstructionsTypeS</span><span class="p">.</span><span class="n">sb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">io</span><span class="p">.</span><span class="n">memory_bundle</span><span class="p">.</span><span class="n">write_strobe</span><span class="p">(</span><span class="n">mem_address_index</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">.</span><span class="nc">B</span>
<span class="w">      </span><span class="n">io</span><span class="p">.</span><span class="n">memory_bundle</span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">reg2_data</span><span class="p">(</span><span class="nc">Parameters</span><span class="p">.</span><span class="nc">ByteBits</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">mem_address_index</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">log2Up</span><span class="p">(</span><span class="nc">Parameters</span><span class="p">.</span><span class="nc">ByteBits</span><span class="p">).</span><span class="nc">U</span><span class="p">)</span>
<span class="w">    </span><span class="p">}.</span><span class="n">elsewhen</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">funct3</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">InstructionsTypeS</span><span class="p">.</span><span class="n">sh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
</code></pre></div>
<p>上面的代码用于写入内存。根据指令的不同，写入的数据会经过不同的处理（<code>sw</code> 取 32 位、<code>sh</code> 取 16 位、<code>sb</code> 取 8 位）。</p>
<h3 id="_9">写回<a class="headerlink" href="#_9" title="Permanent link">🚁</a></h3>
<p>代码位于 <code>core/WriteBack.scala</code> </p>
<p>写回阶段，将计算得到的数据或内存读取的数据写入寄存器。</p>
<p>写回模块只是一个多路选择器，代码非常简单，不再赘述。不过请你思考一个问题：写使能信号在译码阶段就产生了，此时正确的写回数据还没有算出（或从内存读出），那么错误的写回数据会被写入寄存器堆吗？为什么？</p>
<h2 id="cpu_2">组合成 CPU<a class="headerlink" href="#cpu_2" title="Permanent link">🚁</a></h2>
<p>代码位于 <code>core/CPU.scala</code></p>
<p>我们已经实现了构建 CPU 所需要的所有部件。下面我们需要按照单周期 CPU 结构图将上面的部件实例化并且连接起来。</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CPU</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Module</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">CPUBundle</span><span class="p">)</span>
</code></pre></div>
CPUBundle 是 CPU 和内存等外设进行数据交换的通道。</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">regs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">RegisterFile</span><span class="p">)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">inst_fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">InstructionFetch</span><span class="p">)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">InstructionDecode</span><span class="p">)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Execute</span><span class="p">)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">MemoryAccess</span><span class="p">)</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">wb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">WriteBack</span><span class="p">)</span>
</code></pre></div>
<p>这里实例化了不同执行阶段的各个模块。</p>
<p><div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">inst_fetch</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">jump_address_id</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">if_jump_address</span>
<span class="w">  </span><span class="n">inst_fetch</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">jump_flag_id</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">if_jump_flag</span>
</code></pre></div>
以上面两个线路为例，大家在 CPU 原理图中可以看到相应的线路。
`
<a class="glightbox" href="assets/connect.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="assets/connect.png" /></a></p>
<p>请你观察 <code>Execute</code> 模块输入端口代码以及 CPU 结构图，填写 <code>Execute</code> 模块的输入与其他模块输出的连线。</p>
<div class="admonition note">
<p class="admonition-title">实验任务</p>
<p>请在 <code>core/CPU.scala</code> 的 <code>// lab1(CPU)</code> 注释处填入代码，并在lab1下运行 <code>sbt test</code>。</p>
</div>
<p><code>sbt test</code> 会执行包括 CPUTest 以及上述所有单元测试，这一步完成后我们就成功构造出了一个 RISC-V 单周期 CPU 了!</p>
<h2 id="_10">使用自定义应用测试<a class="headerlink" href="#_10" title="Permanent link">🚁</a></h2>
<p>参考<a href="../../practice/compile-and-link.html">编译和链接的过程</a>以及<a href="../../practice/cmake.html">CMake 入门</a>，编写并编译自己的程序后，修改 <code>CPUTest</code> 中的 <code>InstructionROM</code> 的指令文件地址，即可运行你自己的程序。</p>
<p>如果想要烧录自己的程序到 FPGA 板子上，只需要修改 <code>board/&lt;板子型号&gt;/Top.scala</code> 中的 <code>binaryFilename</code> 为你生成的程序二进制文件名即可。</p>
<h2 id="_11">实验报告<a class="headerlink" href="#_11" title="Permanent link">🚁</a></h2>
<!-- 1. 简要概括不同测试用例的功能，描述它们分别从什么层面测试 CPU，以及使用了什么方法加载测试程序指令，以及测试用例的执行结果。
2. 对于填空涉及到的信号，使用测试框架输出波形图，描述在执行不同指令时候对应的部件的关键信号的变化情况。
3. 使用实验板上的数码管、视频输出等外设，输出一个完整程序的运行结果，或者参考[硬件调试](../getting-started/hardware-debug.md)一节的内容，用硬件波形的方法捕获程序运行结果。给出你的 CPU 可以正确在实验板上运行程序的照片或者硬件调试器波形截图。
4. 在完成实验的过程中，遇到的关于实验指导不明确或者其他问题，或者改进的建议。  -->

<ol>
<li><code>src\test\scala\riscv\singlecycle</code> 中的测试文件 <code>ExecuteTest.scala</code>, <code>InstructionDecoderTest.scala</code> 和 <code>InstructionFetch.scala</code> 分别对相应部件进行单元测试，以确保单个部件的正确性。请您选择其中至少一个测试，并<ol>
<li>简述测试文件中的语句是如何测试部件正确性的；</li>
<li>在测试波形图上说明部件运行过程中关键信号的变化。</li>
</ol>
</li>
<li>测试文件 <code>CPUTest.scala</code> 测试了整个 CPU 运行三个程序的正确性。请您选择其中至少一个程序的运行，并<ol>
<li>概述该程序做了什么，执行结果如何被检查；</li>
<li>在测试波形图上简单分析其执行，并说明检查执行结果时的波形。</li>
</ol>
</li>
<li>说明您在完成实验的过程中，遇到的实验指导不足或改进建议。</li>
</ol>
<!-- 
## 提交 Autograder

完成以上所有实验并通过相应测试后，请将以下文件打包为 `.zip` 文件，并上传到 Autograder 进行进一步的测试：

- `src/main/scala/riscv/core/ProgramCounter.scala`
- `src/main/scala/riscv/core/InstructionDecode.scala`
- `src/main/scala/riscv/core/RegisterFile.scala`
- `src/main/scala/riscv/core/ALU.scala`

请确保 Autograder 提交界面显示的完整文件路径包含上述文件路径且完全一致。多余的文件可以上传但将被忽略。
-->












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2023 Tokisakix
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.tabs.link", "navigation.expand"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>