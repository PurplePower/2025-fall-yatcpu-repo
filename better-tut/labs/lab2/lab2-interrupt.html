
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Tokisakix">
      
      
        <link rel="canonical" href="https://purplepower.github.io/2025-fall-yatcpu-repo/better-tut/labs/lab2/lab2-interrupt.html">
      
      
        <link rel="prev" href="../lab1/lab1-single-cycle-cpu.html">
      
      
        <link rel="next" href="../lab3/lab3-pipelined-cpu.html">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>实验二 中断 - 2025-Yatcpu-Fall-Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../index.html" title="2025-Yatcpu-Fall-Docs" class="md-header__button md-logo" aria-label="2025-Yatcpu-Fall-Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            2025-Yatcpu-Fall-Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              实验二 中断
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../index.html" title="2025-Yatcpu-Fall-Docs" class="md-nav__button md-logo" aria-label="2025-Yatcpu-Fall-Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    2025-Yatcpu-Fall-Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    前言
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../test.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    最终验收
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../intro.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    欢迎来到 YatCPU 教程仓库！
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    实验环境配置
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            实验环境配置
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/windows.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Windows 配置指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/linux-wsl.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux/WSL 配置指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/macos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    macOS 配置指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../env.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    一键配置 docker 环境
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    基础工程知识与技能
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            基础工程知识与技能
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/envvar-and-cmd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    环境变量、Shell 与 常用指令
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/scala-and-chisel.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scala 和 Chisel 编程语言
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/chisel-test.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速测试
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/simulation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    波形仿真
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/compliance-test.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    配置 RISC-V 合规性测试
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/coremark-benchmark.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    配置 CoreMark 性能基准测试
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/program-device.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    烧板验证
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/hardware-debug.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    硬件调试
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/compile-and-link.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    编译与链接
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practice/cmake.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cmake
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../board.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    如何一键烧板
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    理论知识基础
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            理论知识基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/cpu-arch.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    处理器架构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/riscv-isa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RISC-V 指令集架构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/interrupt-and-exception.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    中断和异常
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../theory/bus.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    总线
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    实验
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/lab1-single-cycle-cpu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验一 单周期CPU
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    实验二 中断
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="lab2-interrupt.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    实验二 中断
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#csr" class="md-nav__link">
    <span class="md-ellipsis">
      CSR指令支持
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clint" class="md-nav__link">
    <span class="md-ellipsis">
      中断控制器（CLINT）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="中断控制器（CLINT）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      进入中断处理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="进入中断处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 响应硬件中断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 响应软件中断
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      完成中断处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clint_1" class="md-nav__link">
    <span class="md-ellipsis">
      关于 CLINT 的实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      简单的定时中断发生器
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      实验任务
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cpu" class="md-nav__link">
    <span class="md-ellipsis">
      CPU架构图
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      实验报告
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab3/lab3-pipelined-cpu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验三 流水线 CPU
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab4/lab4-bus.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验四 总线
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../challenge1/challenge1-running-os.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    挑战实验一 运行操作系统
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    快速参考资料
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            快速参考资料
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/riscv-isa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RISC-V 指令集格式
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheets/ide-tips.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IDEA 和 VSCode 使用技巧
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    参考资料
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../acknowledgement.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    致谢
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#csr" class="md-nav__link">
    <span class="md-ellipsis">
      CSR指令支持
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clint" class="md-nav__link">
    <span class="md-ellipsis">
      中断控制器（CLINT）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="中断控制器（CLINT）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      进入中断处理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="进入中断处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 响应硬件中断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 响应软件中断
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      完成中断处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clint_1" class="md-nav__link">
    <span class="md-ellipsis">
      关于 CLINT 的实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      简单的定时中断发生器
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      实验任务
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cpu" class="md-nav__link">
    <span class="md-ellipsis">
      CPU架构图
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      实验报告
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="_1">实验二 中断<a class="headerlink" href="#_1" title="Permanent link">🚁</a></h1>
<p>完成单周期 CPU 实验后，你获得了一个可以简单的按照预期指令执行的处理器。但是这个简单的 CPU 只能按照预先的程序指令一直运行，无法中途打断。然而，我们生活的世界充满了不确定性，一个实用的 CPU 需要能够时刻准备好处理来自外部的事件，及时处理中断，并返回到原来的程序中继续执行。</p>
<p>在本实验中，你将学习到：</p>
<ul>
<li>CSR 寄存器以及其操作命令</li>
<li>中断控制器的原理和设计</li>
<li>编写一个简单的定时中断发生器</li>
</ul>
<p>下面的内容中，不管使用 IDE 还是执行命令，根目录是 <code>lab2</code> 文件夹。</p>
<h2 id="csr">CSR指令支持<a class="headerlink" href="#csr" title="Permanent link">🚁</a></h2>
<p>从预备知识<a href="../../theory/interrupt-and-exception.html">中断与异常</a>我们已经学习到了 CSR 寄存器的基本概念。本实验里我们在单周期 CPU 的基础上增加对 CSR 寄存器的操作指令的支持。</p>
<p>CSR相关操作指令集的细节，包括指令的语义，编码等，都可以通过阅读<a href="https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf">非特权集手册</a>的第九章获得。
中断相关的具体CSR寄存器的内容与对应含义，请查阅<a href="https://github.com/riscv/riscv-isa-manual/releases/download/Priv-v1.12/riscv-privileged-20211203.pdf">特权级手册</a></p>
<p>有了实现单周期 CPU 的经验，我们可以把对 CSR 指令的支持分解为：</p>
<ul>
<li><strong>CSR 寄存器组</strong>：CSR 寄存器是一组类似于 RegisterFile 寄存器组的，地址空间大小为 4096 字节，独立编址的寄存器。
   从指令手册可以看到对CSR寄存器的操作都是原子读写的，CSR指令具体的语义请查阅手册。
   CSR寄存器组需要根据ID模块译码后给出的控制信号和CSR寄存器地址，来对内部寄存器进行寻址，获取其内容并且修改。</li>
<li><strong>ID 译码单元</strong>：ID 译码单元需要识别 CSR 指令，根据手册里描述的指令语义和编码规范，产生相应的传给其它模块的控制信号与数据。</li>
<li><strong>EX 执行单元</strong>：CSR 指令都是原子读写的，即一条指令的执行结果中，既要把目标 CSR 寄存器原来的内容写入到目标通用寄存器中，还要按指令语义把从目标 CSR 寄存器读出来的内容修改之后再写回给该CSR 寄存器。此时 EX 里面的 ALU 单元是空闲的，要得到写入 CSR 寄存器的值，可以复用 ALU，也可以不复用。</li>
<li><strong>WB 写回单元</strong>：支持 CSR 相关操作指令后，写回到目标通用寄存器的数据来源就多了一个从目标 CSR 寄存器读出来的修改前的值。</li>
</ul>
<!-- ----------------------------------------------------------------------- -->

<h2 id="clint">中断控制器（CLINT）<a class="headerlink" href="#clint" title="Permanent link">🚁</a></h2>
<p>CLINT（Core-Local Interrupt）是 RISC-V 架构中提供简单中断和定时器功能的中断处理器，其在中断或异常发生且中断开启时，将暂停CPU当前执行流，设置好相关 CSR 寄存器信息后跳转到中断处理程序中执行中断处理程序。</p>
<p>关键就是该保存哪些信息到对应的CSR寄存器中，答案就是 CPU 执行完当前指令后的下一个状态，比如当前指令是跳转指令，那么 <code>mepc</code> 保存的应该是当前跳转指令的跳转目标地址；以及一些关于中断发生原因的信息。</p>
<p>本实验中，我们希望实现一个支持基本功能的、简单的 CLINT，对于一些特殊情况我们规定：</p>
<ol>
<li>中断到来时，我们认为应该让当前指令执行完后，再跳转到中断处理程序。</li>
<li><code>mstatus</code> 的 <code>mie</code>位（machine interrupt enable）记录中断使能，即是否响应中断。如果当前正在执行一条指令以关闭中断使能，但此刻发生外部中断，则规定这种情况不应响应中断。</li>
<li>我们不考虑嵌套中断的情况，即中断处理过程中忽略到来的中断。</li>
<li>仅考虑在 Machine 特权级下的情况。</li>
</ol>
<!-- 还有一些特殊情况。我们知道外部中断使能由 `mstatus` 内容决定，那么要思考如果当前指令如果是修改 `mstatus` 执行结果是关中断的指令执行时，外部中断到来了，那么下个周期是否应该响应中断？
为了统一起见，我们认为这种情况不应该响应中断，并且我们认为应该让当前指令执行完后，再跳转到中断处理程序。 -->

<p>接下来，我们讨论 CLINT 要处理的情况，包括 进入中断处理 和 完成中断处理。</p>
<h3 id="_2">进入中断处理<a class="headerlink" href="#_2" title="Permanent link">🚁</a></h3>
<h4 id="1">1. 响应硬件中断<a class="headerlink" href="#1" title="Permanent link">🚁</a></h4>
<p>此处将外部设备和定时器的中断归为一类讨论。响应硬件中断时，CPU的工作具体分为两部分：</p>
<p>保存现场，记录CPU当前正在执行程序的下一条指令地址，以便中断处理后恢复执行；以及记录中断信息和设置相应权限。这对应了下面 CSR 上的操作：</p>
<ul>
<li><code>mepc</code>：保存的是中断或者异常处理完成后，CPU返回并开始执行的地址。所以对于异常和中断，<code>mepc</code> 的保存内容需要注意。</li>
<li><code>mcause</code>：保存的是导致中断或者异常的原因，具体代码请查阅特权级手册。</li>
<li><code>mstatus</code>：在响应中断时，需要将 <code>mstatus</code> 寄存器中的 <code>MPIE</code> 标志位设置为 <code>0</code>，禁用中断。 </li>
</ul>
<p>然后从 <code>mtvec</code> 获取中断处理程序的地址，跳转到该地址执行中断处理程序。</p>
<div class="admonition info">
<p class="admonition-title">扩展知识：操作系统与硬件配合处理中断</p>
<p>事实上，中断的处理需要操作系统和硬件的紧密配合。在中断发生前，操作系统就要将中断处理程序写入内存并设置中断跳转向量到 <code>mtvec</code> 。
  中断发生时，CPU保存现场并设置中断信息，操作系统还需保存进程上下文并进行资源调度等工作，完成中断处理也类似。
  后续操作系统课程中你将对此有更全面深入的了解。</p>
</div>
<h4 id="2">2. 响应软件中断<a class="headerlink" href="#2" title="Permanent link">🚁</a></h4>
<p><code>ecall</code> 和 <code>ebreak</code> 指令是触发软件中断的两条 environment 指令。<code>ecall</code> 常用于系统调用，例如请求磁盘读写，<code>ebreak</code> 更多用于调试。
详见非特权级手册第2章的 Environment Call and Breakpoints 。</p>
<p>这两条指令都将触发中断，CSR 的设置操作与响应硬件中断的相似。不同的是，<code>mcause</code> 的设置应参照 environment 相应的代码设置。</p>
<h3 id="_3">完成中断处理<a class="headerlink" href="#_3" title="Permanent link">🚁</a></h3>
<p>不论任何原因进入到中断处理程序后，都需要使用 <code>mret</code> 指令以恢复 CPU 原先程序的执行。
这时候其实干的事与响应中断是大致相同的，只不过需要写入的寄存器只有 <code>mstatus</code>，跳转的目标地址则是从 <code>mepc</code> 获取。</p>
<p>为简单起见，对于 <code>mret</code> 时 <code>mstatus</code> 的要写入的值，就把 MIE 位置为 MPIE 位（Machine Previous Interrupt Enable）。若 MPIE 为 1 的话 <code>mret</code> 就会恢复中断，如果 MPIE 为 0 的话，<code>mret</code> 则不改变 <code>mstatus</code> 的值。</p>
<p>上述实现没有考虑嵌套中断，且以后实现特权级切换的时侯，<code>mstatus</code> 的改变更为复杂。中断的实现在手册中有明确的标准，想进一步了解中断机制的实现可以看特权级手册的 3.1.6.1 小节（Privilege and Global Interrupt-Enable Stack in mstatus register） 以及 9.6节（Traps）。</p>
<p>而异常的现场保存和恢复与中断处理差不多，只不过保存和恢复的内容上有所不同而已，感兴趣的同学可以自行摸索。</p>
<h3 id="clint_1">关于 CLINT 的实现<a class="headerlink" href="#clint_1" title="Permanent link">🚁</a></h3>
<p>CLINT 具体的实现方法很多，我们采用纯组合逻辑实现这个中断控制器。由于基于单周期 CPU 且 CLINT 是组合逻辑，所以外部中断到来时，CLINT 会马上响应。
目前 YatCPU 的主仓库的多周期CPU中的 CLINT 采用状态机来实现。</p>
<p>CLINT 需要一个周期就把多个寄存器的内容修改的功能，而正常的 CSR 指令只能对一个寄存器读-修改-写（Read-Modify-Write, RMW）。所以 CLINT 和 CSR 之间有独立的优先级更高的通路，用来快速更新 CSR 寄存器的值。</p>
<hr />
<!-- -------------------------------------------------------------- -->

<h2 id="_4">简单的定时中断发生器<a class="headerlink" href="#_4" title="Permanent link">🚁</a></h2>
<p>我们要实现一个 MMIO 的定时中断发生器——Timer。</p>
<p>MMIO （Memory Mapped I/O）简单来说就是：该外设用来和 CPU 交互的寄存器是与内存一起编址的，所以 CPU 可以通过访存指令（load/store）来修改这些寄存器的值，从而达到 CPU 和外设交互的目的。</p>
<p>目前在没有实现总线的情况下，使用多路选择器实现 MMIO 即可达到目的。原因主要是我们把取指令的操作和 load/store 访存操作分开了，让 Memory 有单独的一个通路进行取指令操作。
因此我们的模型还是一个 CPU 对多个外围设备，不会出现 CPU 的取指操作与访存操作冲突争抢外设的情况。</p>
<p>所以我们 CPU 发出的逻辑地址要发送到哪个设备，就由逻辑地址的高位作为外围设备的位选信号即可，低位则用于设备内部的寻址。</p>
<p>此外还有定时中断发生器的内部逻辑：两个控制寄存器 <code>enable</code> 寄存器和 <code>limit</code> 寄存器。</p>
<ul>
<li><code>enable</code> 寄存器用来控制定时中断发生器的使能，为 <code>false</code> 则不产生中断， 映射到地址空间的逻辑地址为 0x80000008。</li>
<li><code>limit</code> 寄存器用来控制定时器的中断发生间隔，映射到地址空间的逻辑地址为 0x80000004。中断发生器内部有一个加一计数器，当计数器的值到达 <code>limit</code> 为标准的界限时，定时器会发生一次中断信号（<code>enable</code> 使能情况下）。注：产生中断信号的时长没有太大关系，但是至少应该大于一个 CPU 时钟周期，确保 CPU 能够正确捕捉到该信号即可。</li>
</ul>
<h2 id="_5">实验任务<a class="headerlink" href="#_5" title="Permanent link">🚁</a></h2>
<div class="admonition note">
<p class="admonition-title">实验任务：支持中断处理</p>
<ol>
<li>使 EX 单元支持 CSR 指令的运算。</li>
<li>使 CSR 寄存器组支持 CLINT 和来自 CSR 指令的读写操作。</li>
<li>使 CLINT 支持响应中断并且在中断结束后回到原来的执行流。</li>
<li>使定时中断发生器可以正确产生中断信号，并且实现 Timer 寄存器的 MMIO。</li>
</ol>
<p>请在 <code>// lab2(CLINTCSR)</code> 注释处完成上述支持，并通过 <code>CPUTest</code>、<code>ExecuteTest</code>、<code>CLINTCSRTest</code>、<code>TimerTest</code> 测试。</p>
</div>
<p>EX 执行单元的代码文件位于 <code>src/main/scala/riscv/core/Execute.scala</code></p>
<p>CSR 寄存器组的代码文件位于 <code>src/main/scala/riscv/core/CSR.scala</code></p>
<p>CLINT 的代码文件位于 <code>src/main/scala/riscv/core/CLINT.scala</code></p>
<p>Timer 的代码位于 <code>src/main/scala/peripheral/Timer.scala</code></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>IDEA 可以双击 shift，vscode 可以 shift+P 以打开文件快速搜索面板。</p>
</div>
<!-- 在上面提到的 EX、CSR、CLINT、Timer 四个单元的相应文件里面，请在 `// lab2(CLINTCSR)` 注释处填入相应的代码，使其能够通过 `CPUTest`、`ExecuteTest`、`CLINTCSRTest`、`TimerTest` 测试。 -->

<!-- 如果能够正确完成本次实验，那么你的 CPU 就可以运行更加复杂的程序了，可以运行一下俄罗斯方块程序试试，如果想要上手玩的话，也许需要一个串口转接板，这样就可以通过电脑的键盘通过 UART 串口给程序输入字符了。 -->

<h2 id="cpu">CPU架构图<a class="headerlink" href="#cpu" title="Permanent link">🚁</a></h2>
<p><a class="glightbox" href="assets/single_cycle_cpu_zicsr.drawio.svg" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="" src="assets/single_cycle_cpu_zicsr.drawio.svg" /></a></p>
<hr />
<h2 id="_6">实验报告<a class="headerlink" href="#_6" title="Permanent link">🚁</a></h2>
<ol>
<li><code>CLINTCSRTest.scala</code> 中添加了 CLINT 处理硬件终端和软件中断的两个测试，请您选择至少一个，并：<ol>
<li>简述这个测试通过给部件输入什么信号，以测试 CLINT 的哪些功能？</li>
<li>在测试波形图上，找到一次从开始处理中断到中断处理完成的波形图，并挑选其中关键的信号说明其过程。例如硬件中断的测试中，有在跳转指令和非跳转指令下的两次中断处理测试；软件中断则分别测试了 <code>ecall</code> 和 <code>ebreak</code> 两次中断，选择其中一次即可。</li>
</ol>
</li>
<li><code>CPUTest.scala</code> 中新增了 <code>SimpleTrapTest</code>，其执行 <code>csrc/simpletest.c</code> 的程序。请您：<ol>
<li>简述该测试程序如何测试 CPU 的中断处理正确性。</li>
<li>在测试波形图上找出说明该程序成功执行的信号。</li>
</ol>
</li>
<li>说明您在完成实验的过程中，遇到的实验指导不足或改进建议。</li>
</ol>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2023 Tokisakix
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.tabs.link", "navigation.expand"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>